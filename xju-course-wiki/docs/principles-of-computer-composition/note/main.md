# 计算机组成原理笔记

## 计算机系统概论

#### 计算机的性能指标    

- **吞吐量** 表征一台计算机在某一时间间隔内能够处理的信息量。
- **响应时间** 表征从输入有效到系统产生响应之间的时间度量，用时间单位来度量。
- **利用率** 在给定的时间间隔内系统被实际使用的时间所占的比率，用百分比表示。
- **处理机字长** 指处理机运算器中一次能够完成二进制数运算的位数，如32位、64位。总线宽度一般指CPU中运算器与存储器之间进行互连的内部总线二进制位数。
- **存储器容量** 存储器中所有存储单元的总数目，通常用KB、MB、GB、TB 来表示。
- **存储器带宽** 单位时间内从存储器读出的二进制数信息量，一般用字节数/秒表示。
- **主频/时钟周期** CPU的工作节拍受主时钟控制，主时钟不断产生固定频率的时钟，主时钟的频率(/)叫CPU的主频。度量单位是 MHz(兆赫兹)、GHz(吉赫兹)。
- **CPU 时钟周期** 即主频的倒数，度量单位是 $\mu s$、$ns$。
- **CPU 执行时间** 表示CPU执行一般程序所占用的CPU时间，可用下式计算：CPU 执行时间 = CPU 时钟周期数 $\times$ CPU 时钟周期
- **CPI** 表示每条指令周期数，即执行一条指令所需的平均时钟周期数。用下式计算：CPI = 执行某段程序所需的CPU时钟周期数 / 程序包含的指令条数
- **MIPS** (Million Instructions Per Second) 的缩写，表示平均每秒执行多少百万条定点指令数，用下式计算：MIPS=指令数/程序执行时间 $\times 10^6$
- **FLOPS** (Floating-point Operations Per Second) 的缩写，表示每秒执行浮点操作的次数，用来衡量机器浮点操作的性能

#### 杂项

- 计算机硬件组成要素：运算器、存储器、控制器
- 冯·诺依曼架构：指令和数据放在**同一个存储器**
- 哈佛结构：指令和数据分**放在两个存储器**

## 运算方法和运算器

#### 数据与文字的表示方法

- 计算机中常用的数据格式：定点格式、浮点格式
- 定点格式：*纯小数*：最高位是符号位，剩下的位是小数部分，取值范围 $0\leq |x| \leq 1-2^{-n}$；*纯整数*：最高位是符号位，剩下都是整数部分，取值范围 $ 0\leq |x| \leq 2^n-1$
- 浮点格式：任意一个十进制数 $N=10^E\dots M$，因此可以表示为四部分：阶符、阶码、数符、数码
- 数的机器码表示方法：    
    - 原码表示法：用最高位表示符号，其余位表示数值
    - 补码表示法：用最高位表示符号，其余位表示数值，符号位参与运算
    - 原码 $\rightleftharpoons$ 补码：从最低位直到遇到的第一个 1 的这段序列不变，其余位**除了符号位**均取反
    - 移码表示法：移码常用于表示浮点数的阶码（指数部分）， $[e]_y=2^k+e_{acutal~number}$ ，符号位的规律和原码、补码相反
    - IEEE 754 标准：**31(S，符号)、30-23(E，阶码)、22-0(M，数值)**，其中，$E=e_{acutal~number}+127$，为什么是 +127？因为当 $E=255$ 时，被用来表示特殊数值了
    - 在 IEEE 754 标准中，当 $0<E<255$ 时，表示规格化数，否则一定不是规格化数，具体是啥查书 22 页    

#### 定点加法、减法运算
- 补码加法：符号位参与运算，直接加就行
- 补码减法：把 $[x]_{complementary~code}$ 变成 $[-x]_{complementary~code}$，从最低位直到遇到的第一个 1 的这段序列不变，其余位**包括符号位**均取反
- 溢出检测：双符号运算，若运算后两个符号位异号，则发生溢出；符号位产生的进位和 $\oplus$ 最高有效位产生的进位，1 为溢出，0 为正常

#### 定点运算器的组成

分为逻辑运算（逻辑非、逻辑加、逻辑乘、逻辑异或）和多功能算术/逻辑运算单元

#### 浮点运算方法和浮点运算器

设有两个浮点数 $x$ 和 $y$ ，他们分别为：$x = 2^{E_x} \cdot M_x$，$y = 2^{E_y} \cdot M_y$。

**浮点加减法运算**

$z=x\pm y=(M_x \pm 2^{E_x-E_y}\pm M_y)2^{E_y}$

六步：零操作数检查、对阶、尾数加减运算、规格化、溢出检查（阶码）、舍入

**浮点加乘除运算**

$x\times y=2^{E_x+E_y} \cdot (M_x \times M_y)$

$x \div y=2^{E_x-E_y} \cdot (M_x\div M_y)$

## 存储系统

#### 存储系统概述

- 程序的局部性原理：在某一段时间内频繁访问某一局部的存储器地址空间， 而对此范围以外的地址空间则很少访问的现象。
- 多级存储系统：寄存器 cache（CPU 内） - cache 主存储器（主板内）- 磁盘光盘（主板外）- 磁带
- 主存分类：RAM 和 ROM
- RAM 分类：SRAM（不掉电，记忆不丢失）、DRAM（随着时间推移，电荷会逐渐漏掉，要周期性地刷新）
- ROM 分类：掩膜 ROM、一次可编程 ROM（PROM）、可擦除 PROM（EPROM）、紫外线擦除 EPROM（UV-EPROM）、电擦除 EPROM（EEPROM）、闪速（FLASH）只读存储器
- 端模式：大端模式（高字节放低地址、低字节放高地址），小端模式（低字节放低地址、高字节放高地址）
- 存储器的技术指标：存储容量、存取时间、存储周期、存储器带宽


#### 静态随机存储器

![静态随机存储器存储元阵列](2.png)

- 任何 SRAM 都有三组信号线：地址线、数据线、控制线
- 存储器容量的扩充：位扩展、字拓展、位字扩展

![位扩展](3.png)

![字拓展](4.png)

#### 动态随机存储器

![动态随机存储器读/写时序图](5.png)

DRAM 的刷新操作：集中式刷新、分散式刷新、异步刷新

![对比](6.png)

#### ROM

![ROM 对比](7.png)

#### Cache 存储器

- Cache 的命中率：命中次数 / 总访问次数
- cache/主存系统的平均访问时间 $t_a$：(命中次数*cache 读取时间 + 未命中次数*主存读取时间)/总访问次数
- 访问效率：cache 读取时间/平均访问时间
- 地址映射方式：全相联映射方式、直接映射方式、组相联映射方式
- **全相联映射方式**：允许主存中的任意块映射在 cache 中，（标记）、字地址，高速比较器难实现，只适合小容量 cache 使用。
- **直接映射方式**：*cache 行号* = *主存行号* mod *cache 总行数*，主存地址：区号（除数，也是标记，长度是主存行数的log减去cache行数的log）、区内行号（余数，对应 cache 行数）、字地址，只适合大容量 cache 使用
- **组相联映射方式**：*cache 组号* = *主存行号* mod *cache 总组数*，把 cache 分成 u 组，每组 v 行，主存地址：区号（除数，也是标记，长度是主存行数的log减去cach组数的log）、区内组号（余数，对应 cache 组数）、字地址，适合大容量 cache 使用。
- cache 的替换策略：最不经常使用算法（LFU）、近期最少使用算法（LRU）、随机替换（用的最多、最流行）
- cache 的写操作策略：写回法（命中时只修改 cache 的内容，当行呗换出时才修改主存）、全写法（命中时同时修改 cache 内容和主存内容）、写一次法（写命中和写未命中的处理方法与写回法相同，除了第一次写命中时要写入主存）

## 指令系统
#### 指令系统的发展与性能要求



## 中央处理器

## 总线系统

#### 总线概念和结构形态
- **概念** 构成计算机系统的互联机构，多个系统功能部件之间进行数据传送的公共通路。
- **总线的特性** 
    - 物理特性（*物理连接方式，包括总线的根数、插头、形状、引脚线排列方式*）
    - 功能特性（*描述每一根线的功能，如位宽，我们说数据线的宽度指的就是位宽，而说总线的宽度则往往指的是物理宽度*）
    - 电气特性（*每一根线上信号的传递方向及有效电平范围*）
    - 时间特性（*每根线在什么时间有效*）

- **总线的连接方式** 单总线结构、多总线结构
- 挂在总线上的设备通过**适配器**（亦称*接口*）与 CPU 相连
- 多总线结构中，通过不同类型的桥拓展出不同层次的总线，分别连接高中低速设备
- 现代总线结构包括以下四部分：
    - 数据传送总线 *包括地址线、数据线、控制线*
    - 仲裁总线 *包括总线请求线和总线授权线*
    - 中断和同步总线 *包括中断请求线和中断认可线*
    - 公用线 *包括时钟信号线、电源线、地线、系统复位线、加断点时序信号线*

- **北桥** CPU 总线 - PCI 总线
- **南桥** PCI 总线 - ISA 总线


![单总线结构](8.png)

![多总线结构](9.png)

![早期总线结构](10.png)

![现代总线结构](11.png)

#### 总线接口
- 总线中信息的两种传送方式：串行传送和并行传送
- 串行传送：数据线上一个时钟脉冲一个数据位，串行传送时低位在前、高位在后。因为成本低适合长距离传输
- 并行传送：数据线上同时传输多个数据位，一般采用电位传送
- 分时传送：总线复用
- I/O 功能模块，亦即 *I/O 接口*、*适配器* 具有以下功能：
    - 控制
    - 缓冲
    - 状态
    - 转换 *串并转换或并串转换*
    - 整理
    - 程序中断
    


#### 总线仲裁
- 连接到总线上的功能模块共有两种形态：
    - 主动 主方，*可以启动一个总线周期*，可以是 CPU
    - 被动 从方，*总线周期由其他模块发起*，可以是 CPU、存储器模块

- 多个主设备提出的占用总线请求，采用**优先级**或**公平策略**进行仲裁
- 按照总线仲裁电路的位置不同，分为**集中式仲裁**和**分布式仲裁**
- **集中式仲裁** 
    - 链式查询方式 *亦即菊花链式查询。离总线仲裁器越近则优先级越高。优点是容易扩充设备，缺点是坏了一个设备，其后的设备都不能正常工作。*
    - 计数器定时查方式 *请求设备发送信号后，总线仲裁器的计数器开始计数（从 0 或者上次的 中止点），当计数的值和某发出请求的（可能有多个设备发出了请求）设备的地址相等时，仲裁器将总线授权给该设备。优点是可以动态改变设备优先级，实质上使得每个设备获得总线的授权的优先级相等。代价是增加了线的数量*
    - 独立请求方式 *每个设备都有两条专线用来发送总线请求和接受总线授权，然后在总线仲裁器中排队。优点是响应速度快，优先次序控制灵活，缺点是线有亿点点多。但现代总线标准就是她*

- **分布式仲裁** 每个潜在的主设备都可以向总线仲裁器发送请求（唯一仲裁号），每个仲裁器把仲裁总线上的号与自己的进行比较，仲裁总线上的号大，不予响应，并撤销其仲裁号。最后获胜者的仲裁号保留在仲裁总线上


#### 总线定和数据传送模式
- **同步总线定时协定** 事件出现在总线上的时刻由总线时钟信号来确定，所以总线中包含时钟信号线
- **异步总线定时协定** 后一事件出现在总线上的时刻取决于前一事件出现的时刻，即建立在应答式或互锁机制基础上

## 输入、输出（I/O）系统

#### CPU 与外设之间的信息交换方式

- 通过*I/O 接口*与外设交互
- 端口 接口内可直接被 CPU 访问的*寄存器*，下面都是端口：
    - 命令口 接口内可接收来自主控设备的控制命令的*寄存器*
    - 状态口 接口内向 CPU 报告 I/O 设备的工作状态的*寄存器*
    - 数据口 接口内在外设和总线间交换数据的缓冲寄存器
- 端口的编址方式
    - 统一编址方式
    - I/O 独立编址方式
- I/O 接口与外设间的数据传送方式
    - 无条件传送方式
    - 应答方式
    - 同步传送方式
- CPU 与 I/O 接口之间的数据传送方式
    - 无条件传送方式
    - 程序查询方式
        - 主要由程序实现
        - 电路简单，缺点是 CPU 要等得太久
    - 程序中断方式 主要由程序实现
    - 直接内容访问（DMA）方式 主要由硬件实现
    - 通道和输入/输出处理器 主要由硬件实现

#### 程序查询方式

- 由程序实现
- 接口
    - 设备选择电路
    - 数据缓冲寄存器
    - 设备状态标志
- 轮询设备

#### 程序中断方式

- 中断的基本概念
    - 中断是一种程序随机切换的方式，有时也统称为*异常*。但不是所有的中断都是随机发生的，比如软中断。
- 中断服务程序入口地址的获取
    - 向量中断
    - 查询中断
- 程序中断方式的基本 I/O 接口
    - RD，准备就绪触发器
    - EI，允许中断触发器，可以产生中断禁止，从设备的角度禁止中断
    - IR，中断请求触发器
    - IM，中断屏蔽触发器，可以产生中断屏蔽，从 `CPU` 的角度屏蔽所有中断
- 单级中断
- 多级中断

#### DMA 方式

- DMA 的基本概念
    - 直接内存访问（DMA）是一种数据传送方式，它允许 `CPU` 直接访问外设的内存，而不需要 `CPU` 介入
- DMA 的基本操作
    - 外围设备发出 DMA 请求
    - CPU 响应请求，把 CPU 工作改成 DMA 操作方式，DMA 接管总线
    - DMA 寻址并传送数据
    - DMA 向 CPU 报告操作结果
- DMA 传送方式
    - 成组连续传送（一次只传送一组数据，CPU 空闲时再传送下一组数据，占用 CPU 大量周期）
    - 周期挪用方式（一个个地、分散的地占用 CPU 的周期）
    - 透明 DMA 方式（半个半个地占用 CPU 的周期）
- DMA 控制器的基本组成
    - 内存地址计数器
    - 字计数器
    - 数据缓冲寄存器
    - DMA 请求标志
    - 控制/状态逻辑
    - 中断机构
- DMA 数据传送过程
    - 传送前预处理
    - 正式传送
    - 传送后处理